{
  "hash": "62007a364717f0635203fb2a1ae7cc16",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Visualization\"\nsubtitle: \"\"\nauthor: \"Amaury & Vincent\"\nfooter: \"[Home](../index.qmd)\"\nlogo: \"../img/logos/phi.svg\"\nformat: \n  revealjs:\n    theme: ../slides.scss\n    transition: none\n    slide-number: true\n    center-title-slide: true\ninclude-in-header:\n  - text: |\n      <style>\n      .reveal .custom_smallOutput > div.column:first-child {\n        width: 60%;\n      }\n      .reveal .custom_smallOutput div.column:not(:first-child) {\n        width: 40%;\n      }\n      </style>\nexecute:\n  freeze: auto\n---\n\n\n\n# Visualization\n<font style=\"color:blue; font-weight:bold;\">1. graphics: Good & bad practices</font>  \n<font color=\"gray\">2. individual graphics with ggplot</font>  \n<font color=\"gray\">3. Focus on heatmaps</font>  \n<font color=\"gray\">4. Plot composition</font>  \n<font color=\"gray\">5. some level of automation</font>  \n\n<!--\n- published graphics assessment  \n- Visualisation good practices  \n- Pratice: \"clean\" a graph \n-->\n \n\n## What and why ?\nA scientific visualization is a graphical interface between **people** and **data**.  \n- There are **many** possible graphics for the **same** data.  \n- Different **people** perceive theses graphics differently.  \n<br />\nAn advanced graph:  \n- Conveys **complex** information **clearly**  \n- Integrates multiple layers of **information**  \n- Is **reproducible** and **adaptable** by code  \n- Is **aesthetically** pleasing and follows conventions  \n\n\n## The 10 rules of good graphs\n![](../img/02_visualization/4.10simpleRules.png)\n\n## The 10 rules of good graphs\n:::::::::::::::::: {.r-fit-text}\n\n:::::: {.columns }\n::: {.column style=\"width='50%'; line-height=3em\"}\n*Rule 1:* **Know** your audience. (collaborators, journal readers ...).  \n*Rule 2:* **Identify** the role of the figure (&rArr; geometry).  \n*Rule 3:* **Adapt** to the medium (paper, poster, projection screen ...).  \n*Rule 4:* **Captions** are not optional.  \n*Rule 5:* **never** trust the **defaults** (size, font, colors ...): good enough for any, best for none.  \n:::\n:::{.column  width=\"50%\"}\n*Rule 6:* Use **color** effectively & only when needed.  \n*Rule 7:* Do Not **Mislead** the Reader (see examples below).  \n- As a rule of thumb, use the simplest type of plots   \n*Rule 8:* Avoid \"[Chartjunk](https://www.junkcharts.com/about/)\" (see examples below).  \n<!-- any decorations that do not tell the viewer something new must be banned --> \n<!-- Stephen Few: graphs should ideally ‘‘represent all the data that is needed to see and understand what’s meaningful.’’ --> \n*Rule 9:* **Message** trumps beauty.  \n*Rule 10:* Get the right **tool** (here `R` + `tidyverse` + `ggplot`)\n\n:::\n::::::\n\n\nAdditionally:   \n- seek external opinion.  \n- ensure reproducibility with your code.   \n- know the domain's best practices.  \n\n:::::::::::::::::: \n\n## Common [pitfalls](https://www.data-to-viz.com/caveats.html).\n- A good source of reflexions on graphical representation is:   \n![](../img/02_visualization/5.data-to-viz-caveats.png)\n\n## Common pitfalls 1/4\n:::::: {.columns }\n::: {.column style=\"width='50%'\"}\n![](../img/02_visualization/6.a.heatmap_pb.png)\n:::  \n::: {.column style=\"width='50%'\"}\n![](../img/02_visualization/6.b.heatmap_ok.png)\n:::\n::::::\n- **Inaccessible colors** (here for color blind people)\n\n\n## Common pitfalls 2/4\n![](../img/02_visualization/chartJunk.png)  \n\n- **Chart junk**.  \n\n## Common pitfalls 3/4\n![](../img/02_visualization/misleadingaxes.png){  height=500 }   \n\n- **Misleading axes**.  \n\n## Common pitfalls 4/4\n![](../img/02_visualization/pie_charts.png){ width=\"840\" height=200 margin=0} \n\n## Common pitfalls 4/4\n![](../img/02_visualization/pie_charts.png){ width=\"840\" height=200 margin=0} \n![](../img/02_visualization/pie_charts_correct.png){ width=\"840\" height=200  margin=0}\n\n- **Wrong geometry** (for what you show)\n\n<!--\n================================================================================================\n================================================================================================\n================================================================================================\n-->\n\n# Visualization\n<font color=\"gray\">1. graphics: Good & bad practices</font>  \n<font style=\"color:blue; font-weight:bold;\">2. individual graphics with ggplot</font>  \n<font color=\"gray\">3. Focus on heatmaps</font>  \n<font color=\"gray\">4. Plot composition</font>  \n<font color=\"gray\">5. some level of automation</font>  \n\n\n## Grammar of Graphics { .small}\n:::::::::::::::::: {.r-fit-text }\nLayered grammar of graphics in ggplot2 (as described in [wikipedia](https://en.wikipedia.org/wiki/Wilkinson%27s_Grammar_of_Graphics#Wickham%27s_Layered_Grammar_of_Graphics))\n\n:::::: {.columns }\n::: {.column style=\"width='50%'; line-height=2em\"}\n\n* **Defaults**: consists of data and mapping.  \n  + **Data**: dataset\n  + **Mapping**: aesthetic mappings\n:::\n::: {.column style=\"width='50%'; line-height=2em\"}\n* **Layer**: consists of data, mapping, geom, stat, and position\n  + **Data**: dataset, or inherit from defaults\n  + **Mapping**: aesthetic mappings, or inherit from defaults\n  + **Geom**: geometric object\n  + **Stat**: statistical transformation\n  + **Position**: position adjustment\n:::\n::: {.column style=\"width='50%'; line-height=2em\"}\n\n* **Scale**: mapping of data to aesthetic attributes\n* **Coord**: mapping of data to the plane of the plot\n* **Facet**: split up the data\n:::\n:::::: \n&rArr; See also the DebuteR training \n::::::::::::::::::\n\n## The exercise we gave you\n\nAll elements of this grammar of graphics is illustrated by the exercise we gave you by e-mail\n\n:::::: {.columns }\n::: {.column style=\"width='50%'; line-height=2em\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 2\n  weight genotype\n   <dbl> <chr>   \n1   0.23 WT      \n2   0.31 WT      \n3   0.28 WT      \n4   0.23 WT      \n5   0.19 WT      \n6   0.21 WT      \n```\n\n\n:::\n:::\n\n:::\n::: {.column style=\"width='50%'; line-height=2em\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/example_1_processing-1.png){fig-align='center' width=3000}\n:::\n:::\n\n:::\n::::::\n\n## Exercise: {.smaller}\nCorrect this code to get this graphic \n\n::: {.small}\n(hint, we use `viridis`)   \n:::\n\n:::::: {.columns }\n::: {.column style=\"width='75%'; line-height=2em\"}\n:::::::::::::::::: {.r-fit-text }\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\ng <- mtcars %>%\n  mutate(cyl = as.factor(cyl)) %>%\n  ggplot(\n    aes(x = cyl, \n        y = mpg, \n        fill = cyl)) +\n  geom_boxplot() +\n  labs(\n    title = \"Boxplot of MPG by Cylinder\",\n    x = \"Cyl\",\n    y = \"MPG\") +\n  theme_bw() + \n  theme(plot.background = element_rect(fill = \"lightgray\"))\n\ng\n```\n:::\n\n:::::::::::::::::: \n:::\n::: {.column style=\"width='25%'; line-height=2em\"}\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/exercise_wrong_graph_corrected-1.png){fig-align='center' width=3000}\n:::\n:::\n\n:::\n::::::\n\n\n## Other often use improvement: {.smaller}\n### Statistical annotation and expression \nReal world example \n![](../img/02_visualization/together_group_test.png)\n\n\n## Statistical Annotations with `ggpubr` {.smaller}\n- **Compute comparisons and display the p-values**\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\n# install.packages(\"ggpubr\")\nlibrary(ggpubr)\n\nggplot(\n   mtcars, \n   aes(\n     x=as.factor(cyl), \n     y=mpg, \n     fill = as.factor(cyl)\n   )\n ) + \n   geom_boxplot() +\n   stat_compare_means() +\n   theme_classic2()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-2-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n<!--\n# data(\"ToothGrowth\")\n# ggplot(ToothGrowth, aes(x=as.factor(dose), y=len, fill = as.factor(dose))) + \n#   geom_boxplot() +\n#   stat_compare_means() +\n#   theme_classic2()\n-->\n\n## Statistical Annotations with `ggpubr` {.smaller}\n\n- **Compute comparisons and display the p-values**\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nmsleep %>%\n  group_by(order) %>% \n  filter(n()>=6) %>%\nggplot( aes(order, sleep_total, fill = order)) + \n  geom_boxplot() +\n  stat_compare_means(label.y = 22) +\n  stat_compare_means(comparisons = list( \n     c(\"Artiodactyla\", \"Carnivora\"), \n     c(\"Artiodactyla\", \"Primates\"),\n    c(\"Artiodactyla\", \"Rodentia\")\n    ), label = \"p.signif\")  + \n  theme_classic2()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=3000}\n:::\n:::\n\n<!--\n# list(   c(\"Artiodactyla\", \"Carnivora\"), c(\"Primates\", \"Carnivora\"), c(\"Artiodactyla\", \"Primates\"),c(\"Rodentia\", \"Primates\"), c(\"Rodentia\", \"Carnivora\"), c(\"Rodentia\", \"Artiodactyla\")    )\n-->\n\n\n## Exercise\n- Take the code above\n- Change the statistical procedure used by `stat_compare_means`\n- Display the formatted p value of every significant comparison\n\n## Statistical Annotations with `ggpubr` {.smaller}\n\n- **Display p-value from another test procedure**\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nmyTests <- data.frame(\n              group1 = c(\"Artiodactyla\", \"Primates\" , \"Artiodactyla\", \"Rodentia\", \"Rodentia\",  \"Rodentia\") ,\n              group2 = c(\"Carnivora\"   , \"Carnivora\", \"Primates\"    , \"Primates\", \"Carnivora\", \"Artiodactyla\"), \n              p      = c(0.0076        , 0.79       , 0.0012        , 0.047     ,  0.045     ,  0.00057),\n              other  = c(\"S\"           , \"NS\"       , \"S\"           , \"S\"       , \"S\"        , \"S\") \n  \n)\nmsleep %>%\n  group_by(order) %>% \n  filter(n()>=6) %>%\nggplot( aes(order, sleep_total, fill = order)) + \n  geom_boxplot() +\n  stat_pvalue_manual( myTests, y.position = 17, step.increase = 0.05, label = \"other\", tip.length = 0.01) +\n  theme_classic2()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/signif-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Exercise\n- Use the `data(\"ToothGrowth\")`\n- Make the violin plot of teeth length according to the dose of vitamin C \n- Add the pairwise-pvalues\n\n\n## Add (mathematical) expressions {.smaller}\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nggplot(mtcars, aes(x = wt, y = mpg)) +\n    geom_point() +\n    geom_smooth(method = \"lm\", se = TRUE) +\n    stat_cor(label.x = 3, label.y = 34) +\n\n      stat_regline_equation(label.x = 3, label.y = 32) +\n        labs(\n          title = expression(mpg == beta[0] + beta[1]*wt + epsilon[i]),\n          x = expression(log[10](Wt)),\n          y=\"Fuel consumption\"\n               )+\n\n        theme_classic()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=3000}\n:::\n:::\n\n<!--\n#  annotate(\"text\", 7, 80, label = \"y == beta[0] + beta[1]*x + epsilon\", parse = TRUE) +\n-->\n\n## Exercise {.smaller}\n- Start with this plot\n- Use the Mathematical Annotations listed in `?plotmath`\n- Correct the axis label and add the regression formula\n\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nChickWeight %>%\n  filter(Diet==4) %>%\n  ggplot( aes(x = Time, y = weight^(1/3))) +\n    geom_point() +\n    geom_smooth(method = \"lm\", se = TRUE) +\n    labs(\n          title = \"Cube root of weight according to time\",\n          x = \"Time\",\n          y=\"Cube root of weight\"\n    ) +\n    theme_classic() \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n<!--\n================================================================================================\n================================================================================================\n================================================================================================\n-->\n\n# Visualization\n<font color=\"gray\">1. graphics: Good & bad practices</font>  \n<font color=\"gray\">2. individual graphics with ggplot</font>  \n<font style=\"color:blue; font-weight:bold;\">3. Focus on heatmaps</font>  \n<font color=\"gray\">4. Plot composition</font>  \n<font color=\"gray\">5. some level of automation</font>  \n \n\n\n## Complex heatmap {.small}\n* Specific plots like heatmap often have dedicated packages\n* Here we choose the heatmap since\n  - it is widely used\n  - we will use it tomorrow in the project.  \n![](../img/02_visualization/3.ong_2020_fig2.jpg){ height=400  } \n\n## Complex heatmap package\n\n* A bioconductor package\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\n#BiocManager::install(\"ComplexHeatmap\")\nlibrary(ComplexHeatmap)\n```\n:::\n\n\n* with an extensive documentation\n  - available [here](https://jokergoo.github.io/ComplexHeatmap-reference/book/index.html)\n  - or by\n \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\n#BiocManager::install(\"ComplexHeatmap\")\nvignette(\"complex_heatmap\")\n```\n:::\n\n\n## Heatmap structure\n:::::: {.columns }\n::: {.column style=\"width='25%'\"}\n![](../img/02_visualization/heatmap_structure.png){height=400}\n:::  \n::: {.column style=\"width='75%'\"}\n\n![](../img/02_visualization/heatmap_example.png){height=500}\n:::\n::::::\n\n## Data for the heatmap:\n- Let's make a mock dataset \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nset.seed(123)\nmat = matrix(rnorm(120), 10)\n\nrownames(mat) = paste0(\"R\", 1:10)\ncolnames(mat) = paste0(\"C\", 1:12)\n\nrow_info <- data.frame(cond=rnorm(10) < 0, score=runif(10))\ncolumn_info <- data.frame(order=1:12, category=rep(0:2,4) )\n```\n:::\n\n\n\n## Make a basic heatmap {.smaller}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nHeatmap(mat, \n        name=\"my heatmap\", \n        column_title = \"column maybe genes\", \n        row_title = \"row maybe samples\")\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\nBasic layout includes  \n\n- The heatmap.  \n- The row and column labels.  \n- A default clustering.   \n\n## Complete the heatmap: {.smaller}\n### Add annotations \nUsing a dataframe directly give and overview\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        row_title = \"row maybe samples\" , \n        top_annotation = HeatmapAnnotation(df=column_info),\n        left_annotation = HeatmapAnnotation(df=row_info, which = \"row\")\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-11-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Complete the heatmap: {.smaller}\n### Add annotations \nWe have more control by selecting each annotations to be displayed separately\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\ncolumn_annot <- HeatmapAnnotation(\n                 order=anno_barplot(column_info$order), \n                 category=column_info$category)\nrow_annot <- HeatmapAnnotation(\n                  score=anno_barplot(row_info$score),\n                  cond=row_info$cond, which = \"row\")\n\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        row_title = \"row maybe samples\" , \n        top_annotation = column_annot,\n        left_annotation = row_annot\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-12-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Customise colors: {.smaller}\n### The heatmap part\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nmain_col_fun = circlize::colorRamp2(\n                   c(-2, 0, 2),\n                   c(\"darkblue\", \"white\", \"orangered\"))\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        row_title = \"row maybe samples\" , \n        top_annotation = column_annot,\n        left_annotation = row_annot,\n        col = main_col_fun\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-13-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n- We set the limits of the colors ourselves\n- &rArr; Make comparable heatmaps\n\n<!--\nI don't speak about NA values nore the options\n- border_gp = gpar(col = \"black\", lty = 2)\n- rect_gp = gpar(col = \"white\", lwd = 2)\n--> \n\n## Customise colors: {.smaller}\n### Annotations\n\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\ncolumn_annot <- HeatmapAnnotation(\n                 order=anno_barplot(column_info$order), \n                 category=column_info$category,\n                 col=list(category=c(\"0\"=\"#AAE89CFF\", \"1\"=\"#79DB6BFF\", \"2\"=\"#32CD32FF\"))\n                  \n                 )\nrow_annot <- HeatmapAnnotation(\n                  score=anno_barplot(row_info$score),\n                  cond=row_info$cond, which = \"row\",\n                  col=list(cond=c(\"TRUE\"=\"black\", \"FALSE\"=\"white\"))\n                  )\n\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        row_title = \"row maybe samples\" , \n        top_annotation = column_annot,\n        left_annotation = row_annot,\n        col = main_col_fun\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-14-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## customise colors: {.smaller}\n### Titles\n\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        column_title_gp = gpar(fill = \"grey\", col = \"white\", border = \"blue\"),\n        row_title = \"row maybe samples\" , \n        top_annotation = column_annot,\n        left_annotation = row_annot,\n        col = main_col_fun\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n<!--\nht_opt$TITLE_PADDING = unit(c(8.5, 8.5), \"points\")\nht_opt(RESET = TRUE)\n-->\n\n## Customise positions  {.smaller}\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n        name=\"my heatmap\",\n        column_title = \"column maybe genes\", \n        column_title_side =\"bottom\",\n        row_title = \"row maybe samples\" , \n        row_title_side =\"right\",\n        bottom_annotation = column_annot,\n        right_annotation = row_annot,\n        col = main_col_fun\n)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-16-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Exercise\n- Take the heatmap we are building\n- Split the row annotation on each side\n- Split the columns annotation on each side\n\n\n## Customise clustering {.smaller}\n- Either use or remove the clustering \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, name = \"mat\", cluster_rows = FALSE, cluster_columns = FALSE) \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-17-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Customise clustering {.smaller}\n- Either use or remove the clustering \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nbasic_ht <- Heatmap(mat, name = \"mat\") \nrow_order(basic_ht)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1]  6  3  4  5  1  9  2 10  7  8\n```\n\n\n:::\n\n```{.r .cell-code .code-overflow-wrap}\ncolumn_order(basic_ht)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] 10  2  4  1  8  6  5 12  9  7 11  3\n```\n\n\n:::\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, name = \"mat\", cluster_rows = FALSE, cluster_columns = FALSE) \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-18-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n## Customise clustering {.smaller}\n- We can change the display of the dendrogram\n\n::: {.cell layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n    name = \"mat\",\n    row_dend_width = unit(4, \"cm\"),\n    row_dend_side = \"right\",\n    column_dend_height = unit(4, \"cm\"),\n    column_dend_side = \"bottom\"\n  )\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n## Customise clustering {.smaller}\n- We can change the clustering methods parameters as in `hclust`\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n       name = \"mat\", \n       clustering_distance_rows = \"pearson\",\n       column_title = \"pre-defined distance method (1 - pearson)\"\n       )\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-20-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Customise clustering {.smaller}\n- We can give a already made dendrogram\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nrow_dend = as.dendrogram(hclust(dist(mat)))\nrow_dend = dendextend::color_branches\t(row_dend, k = 2) \nHeatmap(mat, \n        name = \"mat\", \n        cluster_rows = row_dend\n        )\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-21-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n## Split heatmap {.smaller}\n### by clustering\n- using `row_km`/`column_km` or `column_split` /`row_split`\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, name = \"mat\", cluster_rows = row_dend, row_split = 2, column_split = 3)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-22-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Split heatmap {.smaller}\n### by categorical variables\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nHeatmap(mat, \n        name = \"mat\", \n        row_split = row_info$cond\n      )\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-23-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n\n## Exercise\n- Take a previous heatmap with the annotations\n- Change the clustering parameters\n- Split the heatmap according to the clustering\n- Recover the row labels in the order of the clustering\n\n<!--\n================================================================================================\n================================================================================================\n================================================================================================\n-->\n# Visualization\n<font color=\"gray\">1. graphics: Good & bad practices</font>  \n<font color=\"gray\">2. individual graphics with ggplot</font>  \n<font color=\"gray\">3. Focus on heatmaps</font>  \n<font style=\"color:blue; font-weight:bold;\">4. Plot composition</font>  \n<font color=\"gray\">5. some level of automation</font>  \n\n## 3 kind of plot composition\n* Split a plot by conditions: `facet`\n* Make one plot from several: `aplot`\n* Put together several plots: `ggarrange` and `patchwork`\n\n## Split a plot by conditions: `facet` {.smaller}\n- See the course for R beginners\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nChickWeight %>%\n  filter(Diet==4) %>%\n  ggplot( aes(x = Time, y = weight^(1/3))) +\n    geom_point() +\n    geom_smooth(method = \"lm\", se = TRUE) +\n    labs(\n          title = \"Cube root of weight according to time\",\n          x = \"Time\",\n          y=\"Cube root of weight\"\n    ) +\n    theme_classic() \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-24-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n\n## Split a plot by conditions: `facet` {.smaller}\n- See the course for R beginners\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\np <- ChickWeight %>% \n  ggplot( aes(x = Time, y = weight^(1/3))) +\n    geom_point() +\n    geom_smooth(method = \"lm\", se = TRUE) +\n    labs(\n          title = \"Cube root of weight according to time\",\n          x = \"Time\",\n          y=\"Cube root of weight\"\n    ) +\n    theme_classic() \n```\n:::\n\n\n## Split a plot by conditions: `facet` {.smaller}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\np + facet_wrap( ~ Diet) \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-26-1.png){fig-align='center' width=3000}\n:::\n:::\n\n \n## Split a plot by conditions: `facet` {.smaller}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\np + facet_grid( Diet ~ .) \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-27-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n## Make one plot from several: `aplot` {.smaller}\n- Real life example\n\n![](../img/02_visualization/aplot.png){height=500}\n\n\n## Make one plot from several: `aplot` {.smaller}\n- Working code example\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nlibrary(aplot)\n\np <- ggplot(mtcars, aes(mpg, disp)) + geom_point()\np2 <- ggplot(mtcars, aes(mpg)) + \n    geom_density(fill='steelblue', alpha=.5) + \n        ggfun::theme_noxaxis()\np3 <- ggplot(mtcars, aes(x=1, y=disp)) + \n    geom_boxplot(fill='firebrick', alpha=.5) + \n    theme_void()\np %>% \n    insert_top(p2, height=.3) %>% \n    insert_right(p3, width=.1)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-28-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n\n## Put together several plots with `patchwork`  {.smaller}\n\n`ggarrange` and `patchwork` are ways to assemble several plots in a single figure. For `ggarrange` se the beginner R course\n\n`patchwork` defines. or augments 6 operators on plots: `+ - / | * &` the most user friendly ones are `+ |` and `/`\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\n# install.packages(\"patchwork\")\nlibrary(patchwork)\n```\n:::\n\n\n## `patchwork`  **example data**\nWe will combine thoses 3 plots:\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\np1 <- ggplot(mtcars, aes(mpg, wt)) + geom_point()\np2 <- ggplot(mtcars, aes(x = cyl)) + geom_bar()\np3 <-  ggplot(mtcars) + geom_boxplot(aes(gear, disp, group = gear))\n```\n:::\n\n\n## `patchwork`  **Basic usage** {.smaller}\n`+` group the plots\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 + p2  + p3 \n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-31-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Basic usage** {.smaller}\n`|`  put the plots side by side\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 + p2  | p3\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-32-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Basic usage** {.smaller}\n`/` stack the plots together\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 / p2\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-33-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Set the layouts** {.smaller}\n`plot_layout` give a finer control over the resulting plot\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 + p2 + p3 + plot_layout(ncol = 1)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-34-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Set the layouts** {.smaller}\n`plot_layout` give a finer control over the resulting plot\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 | p2 + p3 + plot_layout(ncol = 1)\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-35-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Set the layouts** {.smaller}\n`plot_layout` give a finer control over the resulting plot\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 | p2 + p3 + plot_layout(ncol = 1, heights = c(2, 1))\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-36-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Nesting levels** {.smaller}\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n(p1 + ( p2 + p3)) + plot_layout(ncol = 1, heights = c(2, 1))\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-37-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Add other customisation** {.smaller}\nExample with `theme_...`\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 | p2 + p3 + plot_layout(ncol = 1, heights = c(2, 1)) + theme_bw()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-38-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Add other customisation** {.smaller}\nExample with `theme_...`\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np1 | p2 + p3 + plot_layout(ncol = 1, heights = c(2, 1))  & theme_bw()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-39-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## `patchwork` **Add other customisation** {.smaller}\nExample with `theme_...`\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n(p1 | p2 + p3 + plot_layout(ncol = 1, heights = c(2, 1)) ) & theme_bw()\n```\n\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-40-1.png){fig-align='center' width=3000}\n:::\n:::\n\n\n## Exercise: make a Multipanel Figure\n- Take any 3 graphics generated today\n- Use `patchwork` to combine them in a single figure.\n\n<!--\n## Figure annotations\n\nggplot2::annotate\nggplot2::annotation_custom\nggpubr::annotate_figure\t\n\n-->\n\n\n\n\n<!--\n================================================================================================\n================================================================================================\n================================================================================================\n-->\n\n# Visualization\n<font color=\"gray\">1. graphics: Good & bad practices</font>  \n<font color=\"gray\">2. individual graphics with ggplot</font>  \n<font color=\"gray\">3. Focus on heatmaps</font>  \n<font color=\"gray\">4. Plot composition</font>  \n<font style=\"color:blue; font-weight:bold;\">5. some level of automation</font>  \n\n## Functions \n:::::::::::::::::: {.r-fit-text }\nA function in R is 2 things\n\n:::::: {.columns }\n::: {.column style=\"width='50%'\"}\n- A block of code stored and executed when called.\n:::\n::: {.column style=\"width='50%'\"}\n- An object composed of   \n\n|component|accessed using|\n|-|-|\n|arguments|`formals()`|\n|body|`body()`|\n|environment|`environment()`|\n\n:::\n::: {.column style=\"width='30%'\"}\n:::\n::::::\n\nA function can be created in two ways  \n\n- Use a function that creates specific functions like `colorRamp2()`  \n- Use the function `function()`  \n\n::::::::::::::::::\n\n## Functions: example {.smaller}\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\n# Pval_Pyramids\n# Indicates the number of pvalues in each categories according to the hard coded threshold\n# args: pvals: a vector of numeric values assumed to be pvalues\n# return: a dataframe with columns interval and nb\nPval_Pyramids <- function(pvals){\n  breaksForCut <- c(-1, 0, 1e-300, 1e-200, 1e-100, 1e-50, 1e-10, 1e-5, 1e-4, 1e-3, 1e-2, 5e-2, 1)\n  labelsForCut <- c(\"p=0\", \"0<p<=1e-300\", \"1e-300<p<=1e-200\", \"1e-200<p<=1e-100\", \"1e-100<p<=1e-50\", \"1e-50<p<=1e-10\", \"1e-10<p<=1e-05\", \"1e-05<p<=1e-4\", \"1e-4<p<=0.001\", \"0.001<p<=0.01\", \"0.01<p<=0.05\", \"0.05<p<=1\")\n  Ppyram <- pvals %>% \n              cut(breaks=breaksForCut, labels=labelsForCut)  %>% \n              table() %>% as.data.frame() %>% \n              rename(interval=1, nb=Freq)\n  return(Ppyram)\n}\n```\n:::\n\n\n## Functions: exercise \n\n- Take any code for a plot and make a fucntion of it\n- Apply this function (on other data)\n\n\n\n## `for` loops {.smaller}\n- Most used kind of loops (in our experience)\n- Principle: define an object that will take different values successively \n- Repeat the same process on this object `for` each value\n\n\n::: {.cell .custom_smallOutput layout-align=\"center\" output-location='column'}\n\n```{.r .cell-code .code-overflow-wrap}\niteration <- c(\"toto\", \"titi\", \"tata\")\n\nfor(i in iteration){\n  print(i)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"toto\"\n[1] \"titi\"\n[1] \"tata\"\n```\n\n\n:::\n:::\n\n\n<font color=red> &#9888; loops are used to iterate over parameters than are not in the data, not over the data (use apply instead)</font>\n\n## `for` loops: example {.smaller}\n- Test several splits of cluters\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nfor(k in 2:4) {\n  htmp <- Heatmap(mat, name = \"mat\", row_km = k, row_title = \"cluster_%s\")  \n  print(htmp)\n}\n```\n:::\n\n\n## `for` loops: example {.smaller}\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n:::::: {.columns }\n::: {.column style=\"width='30%'\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-44-1.png){fig-align='center' width=1800}\n:::\n:::\n\n:::\n::: {.column style=\"width='30%'\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-45-1.png){fig-align='center' width=1800}\n:::\n:::\n\n:::\n::: {.column style=\"width='30%'\"}\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](02_visualization_files/figure-revealjs/unnamed-chunk-46-1.png){fig-align='center' width=1800}\n:::\n:::\n\n:::\n::::::\n\n## `for` loops: exercise \n- Correct this loop  \n\n(if it is easy:\n\n- Keep the different heatmaps in a list\n- Print them outside this loop  \n)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code .code-overflow-wrap}\nfor(k is 2:4) {\n  Heatmap(mat, name = \"mat\", row_km = i, row_title = \"cluster_%s\")  \n}\n```\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n<!--\n================================================================================================\n================================================================================================\n================================================================================================\n-->\n# End of day discussion\nDo you have any question or remarks on any of the points we discussed ?  \n\n1. graphics: Good & bad practices\n2. individual graphics with ggplot\n3. Focus on heatmaps\n4. Plot composition\n5. Some level of automation\n",
    "supporting": [
      "02_visualization_files/figure-revealjs"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}