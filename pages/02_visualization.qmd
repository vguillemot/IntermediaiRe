---
title: "Visualization"
subtitle: ""
author: "Amaury & Vincent"
footer: "[Home](../index.qmd)"
logo: "../img/logos/phi.svg"
format: 
  revealjs:
    theme: ../slides.scss
    transition: none
    slide-number: true
    center-title-slide: true

execute:
  freeze: auto
---

```{r}
#| include: false

# figure options
knitr::opts_chunk$set(
  fig.width = 10, fig.asp = 0.618,
  fig.retina = 3, dpi = 300, fig.align = "center"
)
```

# Visualization
<font style="color:blue; font-weight:bold;">1. graphics: Good & bad practices</font>  
<font color="gray">2. individual graphics with ggplot</font>  
<font color="gray">3. Focus on heatmaps</font>  
<font color="gray">4. Plot composition</font>  
<font color="gray">5. some level of automation</font>  

<!--
- published graphics assessment  
- Visualisation good practices  
- Pratice : "clean" a graph 
-->
 

## What and why ?
A scientific visualization is a graphical interface between **people** and **data**.  
- There are **many** possible graphics for the **same** data.  
- Different **people** perceive theses graphics differently.  
<br />
An advanced graph :  
- Conveys **complex** information **clearly**  
- Integrates multiple layers of **information**  
- Is **reproducible** and **adaptable** by code  
- Is **aesthetically** pleasing and follows conventions  


## The 10 rules of good graphs
![](../img/02_visualization/4.10simpleRules.png)

## The 10 rules of good graphs
:::::::::::::::::: {.r-fit-text}

:::::: {.columns }
::: {.column style="width='50%'; line-height=3em"}
*Rule 1:* **Know** your audience. (collaborators, journal readers ...).  
*Rule 2:* **Identify** the role of the figure (&rArr; geometry).  
*Rule 3:* **Adapt** to the medium (paper, poster, projection screen ...).  
*Rule 4:* **Captions** are not optional.  
*Rule 5:* **never** trust the **defaults** (size, font, colors ...): good enough for any, best for none.  
:::
:::{.column  width="50%"}
*Rule 6:* Use **color** effectively & only when needed.  
*Rule 7:* Do Not **Mislead** the Reader (see examples below).  
- As a rule of thumb, use the simplest type of plots   
*Rule 8:* Avoid "[Chartjunk](https://www.junkcharts.com/about/)" (see examples below).  
<!-- any decorations that do not tell the viewer something new must be banned --> 
<!-- Stephen Few : graphs should ideally ‘‘represent all the data that is needed to see and understand what’s meaningful.’’ --> 
*Rule 9:* **Message** trumps beauty.  
*Rule 10:* Get the right **tool** (here `R` + `tidyverse` + `ggplot`)

:::
::::::


Additionally:   
- seek external opinion.  
- ensure reproducibility with your code.   
- know the domain's best practices.  

:::::::::::::::::: 

## Common [pitfalls](https://www.data-to-viz.com/caveats.html).
- A good source of reflexions on graphical representation is:   
![](../img/02_visualization/5.data-to-viz-caveats.png)

## Common pitfalls 1/5
:::::: {.columns }
::: {.column style="width='50%'"}
![](../img/02_visualization/6.a.heatmap_pb.png)
:::  
::: {.column style="width='50%'"}
![](../img/02_visualization/6.b.heatmap_ok.png)
:::
::::::
- **Inaccessible colors** (here for color blind people)


## Common pitfalls 2/5
![](../img/02_visualization/chartJunk.png)  

- **Chart junk**.  

## Common pitfalls 3/5
![](../img/02_visualization/misleadingaxes.png){  height=500 }   

- **Misleading axes**.  

## Common pitfalls 4/5
![](../img/02_visualization/pie_charts.png){ width="840" height=200 margin=0} 

## Common pitfalls 5/5
![](../img/02_visualization/pie_charts.png){ width="840" height=200 margin=0} 
![](../img/02_visualization/pie_charts_correct.png){ width="840" height=200  margin=0}

- **Wrong geometry** (for what you show)

<!--
================================================================================================
================================================================================================
================================================================================================
-->

# Visualization
<font color="gray">1. graphics: Good & bad practices</font>  
<font style="color:blue; font-weight:bold;">2. individual graphics with ggplot</font>  
<font color="gray">3. Focus on heatmaps</font>  
<font color="gray">4. Plot composition</font>  
<font color="gray">5. some level of automation</font>  


## Grammar of Graphics { .small}
:::::::::::::::::: {.r-fit-text }
Layered grammar of graphics in ggplot2 (as described in [wikipedia](https://en.wikipedia.org/wiki/Wilkinson%27s_Grammar_of_Graphics#Wickham%27s_Layered_Grammar_of_Graphics))

:::::: {.columns }
::: {.column style="width='50%'; line-height=2em"}

* **Defaults**: consists of data and mapping.  
  + **Data**: dataset
  + **Mapping**: aesthetic mappings
:::
::: {.column style="width='50%'; line-height=2em"}
* **Layer**: consists of data, mapping, geom, stat, and position
  + **Data**: dataset, or inherit from defaults
  + **Mapping**: aesthetic mappings, or inherit from defaults
  + **Geom**: geometric object
  + **Stat**: statistical transformation
  + **Position**: position adjustment
:::
::: {.column style="width='50%'; line-height=2em"}

* **Scale**: mapping of data to aesthetic attributes
* **Coord**: mapping of data to the plane of the plot
* **Facet**: split up the data
:::
:::::: 
&rArr; See also the DebuteR training 
::::::::::::::::::

## The exercise we gave you

All elements of this grammar of graphics is illustrated by the exercise we gave you by e-mail

:::::: {.columns }
::: {.column style="width='50%'; line-height=2em"}

```{r example_1_dataimport}
#| echo: FALSE

library(dplyr)
library(ggplot2)
library(readxl)
library(ggbeeswarm)
library(ggprism)

ex1 <- read_excel("../data/fig2a.xlsx")
head(ex1)

```
:::
::: {.column style="width='50%'; line-height=2em"}

```{r example_1_processing}
#| echo: FALSE

ex1 <- ex1 %>% mutate(genotype=factor(genotype, levels=c("WT", "KO")))

# base of the graph
g <- ggplot(data = ex1, mapping = aes(x=factor(genotype, levels=c("WT", "KO")), y=weight, color=genotype)) 
# add Layer 
# + geom_point()
g <- g  + geom_beeswarm(show.legend = FALSE) # or g + theme(legend.position="none")
# add scales
g <- g + scale_color_manual(values=c("orangered", "darkolivegreen"))

# graph annotations
g <- g + labs( y="Tumor weight at day 14 (g)", x="")
# handle the look & feel
g <- g + theme_prism()

g <- g + scale_y_continuous(limits=c(0,NA), expand = c(0, 0.05)) # or  g + expand_limits( y = 0)
g
```
:::
::::::

## exercise:
Correct this code to get this graphic 

::: {.small}
(hint, we use `viridis`)   
:::

:::::: {.columns }
::: {.column style="width='75%'; line-height=2em"}
:::::::::::::::::: {.r-fit-text }

```{r exercise_wrong_graph .small}
#| echo: TRUE
#| eval: FALSE

g <- mtcars %>%
  mutate(cyl = as.factor(cyl)) %>%
  ggplot(
    aes(x = cyl, 
        y = mpg, 
        fill = cyl)) +
  geom_boxplot() +
  labs(
    title = "Boxplot of MPG by Cylinder",
    x = "Cyl",
    y = "MPG") +
  theme_bw() + 
  theme(plot.background = element_rect(fill = "lightgray"))

g

```
:::::::::::::::::: 
:::
::: {.column style="width='25%'; line-height=2em"}

```{r exercise_wrong_graph_corrected}
#| echo: FALSE
#| eval: TRUE

g <- mtcars %>%
  mutate(cyl = as.factor(cyl)) %>%
  ggplot(aes(x = cyl, y = mpg, fill = cyl)) +
  geom_boxplot() +
  scale_fill_viridis_d(begin = 0.3, end = 0.9) + 
  labs(title = "Fuel consumption distribution",
       subtitle = "According to the number of cylinders",
       x = "Number of cylinders",
       y = "Miles per gallon (US)",
       fill = "Cylinders") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.title.y = element_text(angle = 0, vjust = 0.5, size = 12),
        axis.title.x = element_text(size = 12))

g
```
:::
::::::


## Other often use improvement: 
### Statistical annotation and expression {.small}
- Real world example 
![](../img/02_visualization/together_group_test.png)


## Statistical Annotations with `ggpubr`
- **compute comparisons and display the p-values**
```{r }
#| eval: true
#| echo: false


# Load the library
# install.packages("ggpubr")
library(ggpubr)

# data("ToothGrowth")
# ggplot(ToothGrowth, aes(x=as.factor(dose), y=len, fill = as.factor(dose))) + 
#   geom_boxplot() +
#   stat_compare_means() +
#   theme_classic2()

ggplot(mtcars, aes(x=as.factor(cyl), y=mpg, fill = as.factor(cyl))) + 
   geom_boxplot() +
   stat_compare_means() +
   theme_classic2()
```

## Statistical Annotations with `ggpubr`

- **compute comparisons and display the p-values**
```{r }
msleep %>%
  group_by(order) %>% 
  filter(n()>=6) %>%
ggplot( aes(order, sleep_total, fill = order)) + 
  geom_boxplot() +
  stat_compare_means(label.y = 22) +
  stat_compare_means(comparisons = list( 
     c("Artiodactyla", "Carnivora"), 
     c("Artiodactyla", "Primates"),
    c("Artiodactyla", "Rodentia")
    ), label = "p.signif")  + 
  theme_classic2()

# list(   c("Artiodactyla", "Carnivora"), c("Primates", "Carnivora"), c("Artiodactyla", "Primates"),c("Rodentia", "Primates"), c("Rodentia", "Carnivora"), c("Rodentia", "Artiodactyla")    )
```

## Exercice

- take the code above
- change the statistical procedure used by `stat_compare_means`
- display the formatted p value of every significant comparison

## Statistical Annotations with `ggpubr`

- **Display p-value from another test procedure**
```{r signif, warning=FALSE, fig.height=4}
myTests <- data.frame(
              group1 = c("Artiodactyla", "Primates" , "Artiodactyla", "Rodentia", "Rodentia",  "Rodentia") ,
              group2 = c("Carnivora"   , "Carnivora", "Primates"    , "Primates", "Carnivora", "Artiodactyla"), 
              p      = c(0.0076        , 0.79       , 0.0012        , 0.047     ,  0.045     ,  0.00057),
              other  = c("S"           , "NS"       , "S"           , "S"       , "S"        , "S") 
  
)
msleep %>%
  group_by(order) %>% 
  filter(n()>=6) %>%
ggplot( aes(order, sleep_total, fill = order)) + 
  geom_boxplot() +
  stat_pvalue_manual( myTests, y.position = 17, step.increase = 0.05, label = "other", tip.length = 0.01) +
  theme_classic2()
```

## Exercice
- use the `data("ToothGrowth")`
- make the violin plot of teeth length according to the dose of vitamin C 
- Add the pairwise-pvalues


## Add (mathematical) expressions
```{r}
#| eval: true

ggplot(mtcars, aes(x = wt, y = mpg)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    stat_cor(label.x = 3, label.y = 34) +

      stat_regline_equation(label.x = 3, label.y = 32) +
        labs(
          title = expression(mpg == beta[0] + beta[1]*wt + epsilon[i]),
          x = expression(log[10](Wt)),
          y="Fuel consumption"
               )+

        theme_classic()
        
#  annotate("text", 7, 80, label = "y == beta[0] + beta[1]*x + epsilon", parse = TRUE) +
        
```


## exercice
- start with this plot
- use the Mathematical Annotations listed [here](https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/plotmath.html)
- Correct the axis label and add the regression formula

```{r}
#| eval: TRUE
#| echo: TRUE

ChickWeight %>%
  filter(Diet==4) %>%
  ggplot( aes(x = Time, y = weight^(1/3))) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    labs(
          title = "Cube root of weight according to time",
          x = "Time",
          y="Cube root of weight"
    ) +
    theme_classic() 
```

```{r}
#| eval: FALSE
#| echo: FALSE

ChickWeight %>% filter(Diet==4) %>%
ggplot( aes(x = Time, y = weight^(1/3))) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    labs(
          title = expression(sqrt(weight,3) == beta[0] + beta[1]*Time + epsilon[i]),
          x = "Time",
          y=expression(sqrt(weight,3))
               )+
        theme_classic() 
```


<!--
================================================================================================
================================================================================================
================================================================================================
-->
